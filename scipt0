let tempo = 0;
let timer;
let ordemEsperada = {
  azul: 1,
  verde: 1,
  vermelho: 1
};
let jogoFinalizado = false;

function iniciarJogo() {
  document.getElementById('tela-inicial').style.display = 'none';
  document.getElementById('jogo').style.display = 'block';
  gerarCartoes();
  iniciarCronometro();
}

function gerarCartoes() {
  const cores = ['azul', 'verde', 'vermelho', 'laranja', 'roxo'];
  const area = document.getElementById('area-cartoes');
  let cartoes = [];

  cores.slice(0, 3).forEach(cor => {
    for (let i = 1; i <= 10; i++) {
      cartoes.push({ numero: i, cor, sujo: false });
    }
  });

  while (cartoes.length < 100) {
    const numero = Math.ceil(Math.random() * 10);
    let cor = cores[Math.floor(Math.random() * cores.length)];
    if (cor === 'branco') cor = 'cinza';
    const sujo = Math.random() < 0.2;
    cartoes.push({ numero, cor, sujo });
  }

  cartoes.sort(() => Math.random() - 0.5);
  cartoes.forEach((c, i) => {
    const div = document.createElement('div');
    div.className = 'cartao';
    div.draggable = true;
    div.style.backgroundColor = getCorHex(c.cor);
    if (c.sujo) div.classList.add('sujo');
    div.dataset.numero = c.numero;
    div.dataset.cor = c.cor;
    div.id = `cartao-${i}`;
    const span = document.createElement('span');
    span.textContent = c.numero;
    div.appendChild(span);
    div.addEventListener('dragstart', dragStart);
    area.appendChild(div);
  });

  document.querySelectorAll('.caixa').forEach(caixa => {
    caixa.addEventListener('dragover', e => e.preventDefault());
    caixa.addEventListener('drop', soltarCartao);
  });
}

function getCorHex(cor) {
  const mapa = {
    azul: '#007BFF',
    verde: '#28A745',
    vermelho: '#DC3545',
    laranja: '#FFA500',
    roxo: '#800080',
    cinza: '#808080'
  };
  return mapa[cor] || '#808080';
}

function dragStart(e) {
  e.dataTransfer.setData('text/plain', e.target.id);
}

function soltarCartao(e) {
  const id = e.dataTransfer.getData('text/plain');
  const cartao = document.getElementById(id);
  const numero = parseInt(cartao.dataset.numero);
  const cor = cartao.dataset.cor;
  const destino = e.currentTarget.dataset.cor;

  if (cor === destino && numero === ordemEsperada[destino]) {
    ordemEsperada[destino]++;
    e.currentTarget.appendChild(cartao);
    verificarFimDeJogo();
  }
}

function verificarFimDeJogo() {
  const caixas = ['azul', 'verde', 'vermelho'];
  const todasCompletas = caixas.every(cor => {
    const caixa = document.querySelector(`[data-cor="${cor}"]`);
    const cartoes = caixa.querySelectorAll('.cartao');
    return cartoes.length === 10;
  });

  if (todasCompletas && !jogoFinalizado) {
    jogoFinalizado = true;
    encerrarJogo(true);
  }
}

function iniciarCronometro() {
  tempo = 0;
  document.getElementById('cronometro').textContent = `Tempo: ${tempo}s`;
  timer = setInterval(() => {
    tempo++;
    document.getElementById('cronometro').textContent = `Tempo: ${tempo}s`;
    if (tempo >= 60 && !jogoFinalizado) {
      jogoFinalizado = true;
      encerrarJogo(false);
    }
  }, 1000);
}

function encerrarJogo(completou) {
  clearInterval(timer);
  document.getElementById('jogo').style.display = 'none';
  document.getElementById('mensagem-final').style.display = 'block';

  const mensagem = completou
    ? `Parabéns, você conseguiu completar a missão! Agora, imagine quão mais fácil seria se não tivesse todos aqueles itens desnecessários, duplicados e sujos no caminho...<br><br>Tempo: ${tempo}s`
    : "O tempo acabou! Itens desnecessários, duplicados e sujos dificultaram a execução da tarefa";

  document.getElementById('mensagem-texto').innerHTML = mensagem;
}

function reiniciarJogo() {
  location.reload();
}
